# PostgreSQL configuration for B3 AI Analysis Platform
# This file is mounted to /etc/postgresql/postgresql.conf in the container

# ============================================
# PERFORMANCE TUNING
# ============================================

# Memory Settings (FASE 143.0: Optimized for 4GB RAM)
shared_buffers = 1GB  # 25% of RAM for cache (increased from 256MB)
effective_cache_size = 3GB  # 75% of RAM for OS + Postgres cache (increased from 1GB)
work_mem = 20MB  # Memory per operation - 1GB / 50 concurrent (increased from 10MB)
maintenance_work_mem = 256MB  # Memory for VACUUM, CREATE INDEX (increased from 64MB)

# Checkpoint Settings
checkpoint_completion_target = 0.9  # Spread checkpoints over 90% of interval
wal_buffers = 16MB                  # Write-Ahead Log buffer

# Query Planner
default_statistics_target = 100  # Statistics for query planner
random_page_cost = 1.1  # SSD-optimized (default 4.0 for HDD)
effective_io_concurrency = 200  # Concurrent I/O operations (SSD)

# Parallel Query (FASE 143.0: Enable parallel execution)
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4

# ============================================
# TIMESCALEDB SETTINGS
# ============================================

# Enable TimescaleDB extension
shared_preload_libraries = 'timescaledb'

# TimescaleDB-specific tuning
timescaledb.max_background_workers = 8

# ============================================
# LOGGING
# ============================================

# Log slow queries (> 1 second)
log_min_duration_statement = 1000

# Log connections and disconnections (FASE 143.0: Disabled for performance)
log_connections = off  # Changed from on
log_disconnections = off  # Changed from on

# Log line format
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# ============================================
# TIMEZONE SETTINGS
# ============================================

# Brazilian timezone for financial data accuracy
timezone = 'America/Sao_Paulo'
log_timezone = 'America/Sao_Paulo'

# ============================================
# CONNECTION SETTINGS
# ============================================

max_connections = 200  # FASE 143.0: Increased from 100 (backend pool + api service + concurrent users)
listen_addresses = '*'  # Listen on all interfaces
