# Promtail Configuration
# FASE 76.3: Log Collection
# Updated: Docker Service Discovery for WSL2/Docker Desktop compatibility

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Docker Service Discovery - Works with Docker Desktop WSL2
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 15s
        filters:
          - name: label
            values: ["com.docker.compose.project=invest-claude-web"]
    relabel_configs:
      # Keep only invest_* containers
      - source_labels: ['__meta_docker_container_name']
        regex: '/?(invest_.*)'
        action: keep
      # Extract container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/?(.*)'
        target_label: container
      # Extract service name from compose labels
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: service
      # Set job label
      - replacement: docker
        target_label: job
    pipeline_stages:
      - json:
          expressions:
            log: log
            stream: stream
            time: time
      - labels:
          stream:
      - timestamp:
          source: time
          format: RFC3339Nano
      - output:
          source: log

  # Collect application logs from shared volume
  - job_name: invest-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: invest
          __path__: /var/log/invest/**/*.log

    pipeline_stages:
      - multiline:
          firstline: '^\d{4}-\d{2}-\d{2}'
          max_wait_time: 3s
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d+Z?)\s+(?P<level>\w+)\s+\[(?P<context>[^\]]+)\]\s+(?P<message>.*)$'
      - labels:
          level:
          context:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  # Backend NestJS logs
  - job_name: backend
    static_configs:
      - targets:
          - localhost
        labels:
          job: backend
          service: invest-backend
          __path__: /var/log/invest/backend*.log

  # Scrapers logs
  - job_name: scrapers
    static_configs:
      - targets:
          - localhost
        labels:
          job: scrapers
          service: invest-scrapers
          __path__: /var/log/invest/scrapers*.log

  # FASE 113: Docker Desktop Host Logs
  # Critical for monitoring VM memory, network issues, and API errors
  - job_name: docker-desktop
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker-desktop
          component: host
          __path__: /var/log/docker-desktop/*.log

    pipeline_stages:
      # Parse JSON logs (most Docker Desktop logs are JSON)
      - match:
          selector: '{job="docker-desktop"}'
          stages:
            - json:
                expressions:
                  level: level
                  msg: msg
                  time: time
                  component: component
                  error: error
            - labels:
                level:
                component:
            - timestamp:
                source: time
                format: RFC3339Nano
            - output:
                source: msg

      # Extract error patterns for alerting
      - match:
          selector: '{job="docker-desktop"} |~ "error|no route|timeout|failed"'
          stages:
            - labels:
                severity: error
