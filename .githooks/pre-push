#!/bin/bash
# Pre-push hook - Validate Build and Tests
# Location: .githooks/pre-push
# Enable: git config core.hooksPath .githooks

echo "ğŸš€ Pre-push validation..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track errors
ERRORS=0

# 1. Build Backend
echo -e "${YELLOW}â†’ Building Backend...${NC}"
cd backend
if ! npm run build; then
    echo -e "${RED}âŒ Backend build failed!${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}âœ… Backend build OK${NC}"
fi
cd ..

# 2. Build Frontend
echo -e "${YELLOW}â†’ Building Frontend...${NC}"
cd frontend
if ! npm run build; then
    echo -e "${RED}âŒ Frontend build failed!${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}âœ… Frontend build OK${NC}"
fi
cd ..

# 3. Run Backend Tests (if exist)
echo -e "${YELLOW}â†’ Running Backend Tests...${NC}"
cd backend
if npm run test --silent 2>/dev/null; then
    echo -e "${GREEN}âœ… Backend tests passed${NC}"
else
    echo -e "${YELLOW}âš ï¸  Backend tests not configured or failed${NC}"
    # NÃ£o bloquear push por falta de testes (ainda)
fi
cd ..

# Final result
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ Pre-push validation FAILED ($ERRORS errors)${NC}"
    echo -e "${RED}   Please fix the build errors before pushing.${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 1
else
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ… All pre-push checks passed!${NC}"
    echo -e "${GREEN}   Safe to push to remote.${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 0
fi
