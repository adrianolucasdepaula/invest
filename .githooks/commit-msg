#!/bin/bash
# Commit-msg hook - Validate Conventional Commits format
# Location: .githooks/commit-msg
# Enable: git config core.hooksPath .githooks

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Conventional Commits regex
# Format: type(scope): description
# Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert
PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{10,}"

if ! echo "$COMMIT_MSG" | head -n 1 | grep -qE "$PATTERN"; then
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}❌ Invalid commit message format!${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}Conventional Commits format required:${NC}"
    echo -e "  ${GREEN}type(scope): description${NC}"
    echo ""
    echo -e "${YELLOW}Valid types:${NC}"
    echo -e "  ${GREEN}feat${NC}     - New feature"
    echo -e "  ${GREEN}fix${NC}      - Bug fix"
    echo -e "  ${GREEN}docs${NC}     - Documentation only"
    echo -e "  ${GREEN}style${NC}    - Code style (formatting, no logic change)"
    echo -e "  ${GREEN}refactor${NC} - Code refactoring"
    echo -e "  ${GREEN}test${NC}     - Adding/updating tests"
    echo -e "  ${GREEN}chore${NC}    - Maintenance tasks"
    echo -e "  ${GREEN}perf${NC}     - Performance improvements"
    echo -e "  ${GREEN}ci${NC}       - CI/CD changes"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo -e "  ${GREEN}feat(assets): add ticker history merge${NC}"
    echo -e "  ${GREEN}fix(portfolio): calculate correct gain of day${NC}"
    echo -e "  ${GREEN}docs(readme): update installation steps${NC}"
    echo ""
    echo -e "${YELLOW}Your commit message:${NC}"
    echo -e "  ${RED}$COMMIT_MSG${NC}"
    echo ""
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    exit 1
fi

# Success
echo -e "${GREEN}✅ Commit message format valid${NC}"
exit 0
